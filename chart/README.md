# Kafka Helm Chart

Helm chart позволяет быстро развернуть и управлять сервисами **producer** и **consumer**.
Взаимодействие между сервисами осуществляетмся с помощью **Kafka**. Состоит из суб-чартов **producer**
и **consumer**. В чарте используется вызов уже готовых чартов **Kafka**, **Postgres** и **Ingress-nginx**.

![Cтруктура приложения в кластере K8s.png](..%2Fdocs%2FC%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%B0%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F%20%D0%B2%20%D0%BA%D0%BB%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B5%20K8s.png)


## Предварительные требования
**Helm**, установленный и настроенный на вашем компьютере.
**Kubernetes кластер**, доступный для **Helm**.

## Установка
Все приведенные ниже команды необходимо выполнять из корневой дирректории проекта.

### Шаг 1: Установка готовых **Helm Chart**
`helm dependency build chart/`

## Шаг 2: Обновление репозитория
Если каталоги уже сккачаны, то необходимо обновить локальные каталоги репозитория Helm, 
чтобы получить последние версии чартов:
`helm repo update`

## Шаг 3: Установка chart
Используйте следующую команду для установки чарта, с именем **app**:
`helm install app chart/`

Для установки с пользовательскими настройками из values_custom.yaml (values_custom.yaml должен находится в корне проекта):
`helm install app chart/ -f values.yaml`

## Шаг 4: Открытие тонеля к кластеру
Для открытия тонеля, откройте отдельное окно консоли и выполните команду
`minikube tunnel`

Не закрывайте это окно консоли до окончания работы с чартом.


# Особенности конфигурации
В данной конфигурации используется два **Ingress контроллера**. Для их одновременной работы вместо оригинального имени чарта
используется alias. Каждому контроллеру соответствует своя конфигурация **ingress**. Что бы контроллеры не конфликтовали
при работе необходимо переопределить **ingress class** и **controller class**, это осуществленно с помощью переопределения 
свойств **controller.ingressClassResource.controllerValue** и **controller.ingressClassResource.name** (см. values.yaml).


# Контроль и мониторинг
После установки вы можете использовать следующие команды для управления и мониторинга вашего кластера:

## Просмотр состояния подов
Чтобы увидеть состояние подов, используйте команду:
`kubectl get pods`
или
`kubectl get pods --watch`

## Просмотр списка служб (services)
Чтобы увидеть список служб (services) в текущем пространстве имен Kubernetes, используйте команду:
`kubectl get svc`

## Логи
Чтобы просмотреть логи пода, используйте команду:
`kubectl logs -l <pod-name>`
 
Просмотреть логи упавшего пода:
`kubectl logs <pod-name> --previous`

## Получить URL для службы (service)
Чтобы получить URL-адрес, по которому можно обращаться службе (service) из браузера или других клиентов:
`minikube service <service_name> --url`

## Обновление чарта новыми конфигурациями
Чтобы обновить чарт, используйте команду:
`helm upgrade <chart_name> chart/`

## Обновление чарта измененными зависимыми чартами
Если вы модифицировали зависимые суб-чарты, выполните их обновление командой: 
`helm dependency update chart/`

## Остановка и удаление
Чтобы остановить и удалить чарт, используйте команду:
`helm delete <chart_name>`